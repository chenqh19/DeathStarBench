version: "3.8"

services:
  jaeger-agent:
    image: jaegertracing/jaeger-agent:latest
    hostname: jaeger-agent
    command: ["--reporter.grpc.host-port=128.253.128.70:14250"]
    deploy:
      mode: global
      # replicas: 4
      restart_policy:
        condition: any
      # placement:
      #   constraints:
      #     - node.nn==used
    depends_on:
      - jaeger-collector

  compose-post-service:
    depends_on:
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-8]
    command: ["ComposePostService"]
    hostname: compose-post-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9090:9090

  home-timeline-redis:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: home-timeline-redis
    image: redis
    command: "redis-server /social-network-microservices/config/redis.conf"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-1]
    ports:
      - 6379:6379

  home-timeline-service:
    depends_on:
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-8]
    command: ["HomeTimelineService"]
    hostname: home-timeline-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9091:9091

  media-frontend:
    depends_on:
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-7]
    hostname: media-frontend
    image: yg397/media-frontend:xenial
    ports:
      - 8081:8080
    volumes:
      - ./media-frontend/lua-scripts:/usr/local/openresty/nginx/lua-scripts
      - ./media-frontend/conf/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf

  # media-memcached:
  #   depends_on:
  #     - jaeger-agent
  #     - jaeger-query
  #   hostname: media-memcached
  #   image: memcached
  #   command:
  #     - "-m 16384"
  #     - "-t 8"
  #     - "-I 32m"
  #     - "-c 4096"
  #   deploy:
  #     restart_policy:
  #       condition: any
  #     placement:
  #       constraints: [node.hostname == ath-8]

  # media-mongodb:
  #   depends_on:
  #     - jaeger-agent
  #     - jaeger-query
  #   hostname: media-mongodb
  #   image: mongo:4.4.6
  #   command: "mongod --nojournal --quiet --config /social-network-microservices/config/mongod.conf"
  #   # command: "mongod --serviceExecutor adaptive --listenBacklog 1024 --syncdelay 3600 --wiredTigerCacheSizeGB 2"
  #   volumes:
  #     - ./config:/social-network-microservices/config
  #     - ./keys:/keys
  #   deploy:
  #     restart_policy:
  #       condition: any
  #     placement:
  #       constraints: [node.hostname == ath-8]

  media-service:
    depends_on:
      - media-mongodb
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-1]
    command: ["MediaService"]
    hostname: media-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9092:9092

  nginx-web-server:
    depends_on:
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-4]
    hostname: nginx-web-server
    image: yg397/openresty-thrift:xenial
    ports:
      - 8080:8080
    volumes:
      - ./nginx-web-server/lua-scripts:/usr/local/openresty/nginx/lua-scripts
      - ./nginx-web-server/pages:/usr/local/openresty/nginx/pages
      - ./nginx-web-server/conf/nginx.conf:/usr/local/openresty/nginx/conf/nginx.conf
      - ./nginx-web-server/jaeger-config.json:/usr/local/openresty/nginx/jaeger-config.json
      - ./gen-lua:/gen-lua
      - ./docker/openresty-thrift/lua-thrift:/usr/local/openresty/lualib/thrift
      - ./keys:/keys

  post-storage-memcached:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: post-storage-memcached
    image: memcached
    command:
      - "-m 16384"
      - "-t 8"
      - "-I 32m"
      - "-c 4096"
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-8]
    ports:
      - 11211:11211

  post-storage-mongodb:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: post-storage-mongodb
    image: mongo:4.4.6
    command: "mongod --nojournal --quiet --config /social-network-microservices/config/mongod.conf"
    # command: "mongod --serviceExecutor adaptive --listenBacklog 1024 --syncdelay 3600 --wiredTigerCacheSizeGB 75"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-8]
    ports:
      - 27017:27017

  post-storage-service:
    depends_on:
      - post-storage-mongodb
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-5]
    command: ["PostStorageService"]
    hostname: post-storage-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9093:9093

  social-graph-mongodb:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: social-graph-mongodb
    image: mongo:4.4.6
    command: "mongod --nojournal --quiet --config /social-network-microservices/config/mongod.conf"
    # command: "mongod --serviceExecutor adaptive --listenBacklog 1024 --syncdelay 3600 --wiredTigerCacheSizeGB 16"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-4]
    ports:
      - 27018:27017

  social-graph-redis:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: social-graph-redis
    image: redis
    command: "redis-server /social-network-microservices/config/redis.conf"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-5]
    ports:
      - 6380:6379

  social-graph-service:
    depends_on:
      - jaeger-agent
      - jaeger-query
      - social-graph-mongodb
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-1]
    command: ["SocialGraphService"]
    hostname: social-graph-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9094:9094

  text-service:
    depends_on:
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-1]
    command: ["TextService"]
    hostname: text-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9095:9095


  unique-id-service:
    depends_on:
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-1]
    command: ["UniqueIdService"]
    hostname: unique-id-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9096:9096

  url-shorten-memcached:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: url-shorten-memcached
    image: memcached
    command:
      - "-m 16384"
      - "-t 8"
      - "-I 32m"
      - "-c 4096"
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-4]
    ports:
      - 11212:11211

  url-shorten-mongodb:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: url-shorten-mongodb
    image: mongo:4.4.6
    command: "mongod --nojournal --quiet --config /social-network-microservices/config/mongod.conf"
    # command: "mongod --serviceExecutor adaptive --listenBacklog 1024 --syncdelay 3600 --wiredTigerCacheSizeGB 36"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-5]
    ports:
      - 27019:27017

  url-shorten-service:
    depends_on:
      - url-shorten-mongodb
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-8]
    command: ["UrlShortenService"]
    hostname: url-shorten-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9097:9097

  user-memcached:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: user-memcached
    image: memcached
    command:
      - "-m 16384"
      - "-t 8"
      - "-I 32m"
      - "-c 4096"
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-5]
    ports:
      - 11213:11211

  user-mention-service:
    depends_on:
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-8]
    command: ["UserMentionService"]
    hostname: user-mention-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9098:9098

  user-mongodb:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: user-mongodb
    image: mongo:4.4.6
    command: "mongod --nojournal --quiet --config /social-network-microservices/config/mongod.conf"
    # command: "mongod --serviceExecutor adaptive --listenBacklog 1024 --syncdelay 3600 --wiredTigerCacheSizeGB 8"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-4]
    ports:
      - 27020:27017

  user-service:
    depends_on:
      - user-mongodb
      - jaeger-agent
      - jaeger-query
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-1]
    command: ["UserService"]
    hostname: user-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    ports:
      - 9099:9099
      
  user-timeline-mongodb:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: user-timeline-mongodb
    image: mongo:4.4.6
    command: "mongod --nojournal --quiet --config /social-network-microservices/config/mongod.conf"
    # command: "mongod --serviceExecutor adaptive --listenBacklog 1024 --syncdelay 3600 --wiredTigerCacheSizeGB 75"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-5]
    ports:
      - 27021:27017

  user-timeline-redis:
    depends_on:
      - jaeger-agent
      - jaeger-query
    hostname: user-timeline-redis
    image: redis
    command: "redis-server /social-network-microservices/config/redis.conf"
    volumes:
      - ./config:/social-network-microservices/config
      - ./keys:/keys
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-4]
    ports:
      - 6381:6379

  user-timeline-service:
    depends_on:
      - user-timeline-mongodb
      - jaeger-agent
    deploy:
      replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-8]
    command: ["UserTimelineService"]
    hostname: user-timeline-service
    image: varungohil/social-network-microservice-spantags:latest
    volumes:
      - ./config:/social-network-microservices/config
    ports:
      - 9100:9100

  jaeger-collector:
    image: jaegertracing/jaeger-collector
    command:
      [
        "--cassandra.keyspace=jaeger_v1_dc1",
        "--cassandra.servers=cassandra",
        "--collector.zipkin.host-port=9411",
        "--collector.num-workers=1000",
        "--collector.queue-size=500000"
      ]
    ports:
      - "14269:14269"
      - "14250:14250"
    deploy:
      # replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-7]
    depends_on:
      - cassandra-schema

  jaeger-query:
    image: jaegertracing/jaeger-query
    command:
      ["--cassandra.keyspace=jaeger_v1_dc1", "--cassandra.servers=cassandra"]
    ports:
      - "16686:16686"
    deploy:
      # replicas: 1
      restart_policy:
        condition: any
      placement:
        constraints: [node.hostname == ath-7]
    depends_on:
      - cassandra-schema

  cassandra-schema:
    image: jaegertracing/jaeger-cassandra-schema
    deploy:
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.hostname == ath-7]
    depends_on:
      - cassandra

  cassandra:
    image: cassandra:3.9
    deploy:
      restart_policy:
        condition: on-failure
      placement:
        constraints: [node.hostname == ath-7]

networks:
  default:
    driver: overlay
    ipam:
      driver: default
      config:
        - subnet: 10.11.0.0/16
